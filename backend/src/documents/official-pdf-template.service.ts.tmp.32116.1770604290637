import { Injectable, Logger } from '@nestjs/common';
import { PrismaService } from '../prisma/prisma.service';
import { QrService } from './qr.service';
import { DocumentNumberingService } from './document-numbering.service';
import * as PDFDocument from 'pdfkit';

/**
 * Official PDF Template Service
 *
 * Generates official government documents with:
 * - Header with national emblem
 * - Document number (top-left): 025-MT-038-051
 * - QR code with number + recipients + date
 * - Signature section (Minister only)
 * - Physical seal placeholder
 * - Footer with recipients
 * - Decree annotations (left margin)
 *
 * Client requirements from physical document analysis
 */
@Injectable()
export class OfficialPdfTemplateService {
  private readonly logger = new Logger(OfficialPdfTemplateService.name);

  constructor(
    private prisma: PrismaService,
    private qrService: QrService,
    private numberingService: DocumentNumberingService,
  ) {}

  /**
   * Generate official PDF for a document
   */
  async generateOfficialPDF(documentId: string): Promise<Buffer> {
    try {
      // Get document with all related data
      const document = await this.prisma.document.findUnique({
        where: { id: documentId },
        include: {
          responsible: {
            select: {
              firstName: true,
              lastName: true,
              email: true,
            },
          },
          entity: {
            select: {
              name: true,
            },
          },
        },
      });

      if (!document) {
        throw new Error('Document not found');
      }

      // Ensure document has a number
      let documentNumber = document.documentNumber;
      if (!documentNumber) {
        documentNumber = await this.numberingService.assignDocumentNumber(
          documentId,
        );
      }

      // Generate enhanced QR code
      const qrCode = await this.qrService.generateEnhancedDocumentQR({
        documentId: document.id,
        documentNumber,
        recipients: document.decretedTo || [],
        date: document.createdAt,
        title: document.title,
      });

      // Create PDF
      return this.createPDFDocument({
        documentNumber,
        title: document.title,
        content: document.content || '',
        date: document.createdAt,
        responsible: document.responsible,
        entity: document.entity,
        qrCode,
        recipients: document.decretedTo || [],
        annotations: [], // Decree annotations if any
      });
    } catch (error) {
      this.logger.error(`Failed to generate official PDF: ${error.message}`);
      throw error;
    }
  }

  /**
   * Create PDF document with official template
   */
  private async createPDFDocument(data: {
    documentNumber: string;
    title: string;
    content: string;
    date: Date;
    responsible: any;
    entity: any;
    qrCode: string;
    recipients: string[];
    annotations: string[];
  }): Promise<Buffer> {
    return new Promise((resolve, reject) => {
      try {
        const doc = new PDFDocument({
          size: 'A4',
          margins: {
            top: 100,
            bottom: 100,
            left: 100, // Extra space for annotations
            right: 50,
          },
        });

        const buffers: Buffer[] = [];
        doc.on('data', buffers.push.bind(buffers));
        doc.on('end', () => {
          const pdfData = Buffer.concat(buffers);
          resolve(pdfData);
        });

        // === HEADER SECTION ===
        this.addHeader(doc, data.documentNumber);

        // === DOCUMENT NUMBER (Top-left) ===
        this.addDocumentNumber(doc, data.documentNumber);

        // === TITLE ===
        doc
          .fontSize(16)
          .font('Helvetica-Bold')
          .text(data.title, { align: 'center' });

        doc.moveDown(1);

        // === CONTENT ===
        doc
          .fontSize(12)
          .font('Helvetica')
          .text(data.content, {
            align: 'justify',
            lineGap: 5,
          });

        doc.moveDown(2);

        // === QR CODE ===
        if (data.qrCode) {
          // Convert base64 to buffer
          const qrBuffer = Buffer.from(
            data.qrCode.replace(/^data:image\/\w+;base64,/, ''),
            'base64',
          );

          doc.image(qrBuffer, doc.page.width - 150, doc.y, {
            width: 100,
            height: 100,
          });
        }

        doc.moveDown(4);

        // === SIGNATURE SECTION ===
        this.addSignatureSection(doc);

        // === FOOTER WITH RECIPIENTS ===
        this.addFooter(doc, data.recipients, data.date);

        // Finalize PDF
        doc.end();
      } catch (error) {
        reject(error);
      }
    });
  }

  /**
   * Add official header with ministry information
   */
  private addHeader(doc: any, documentNumber: string) {
    // TODO: Add national emblem image when available
    // For now, add placeholder text
    doc
      .fontSize(10)
      .font('Helvetica-Bold')
      .text('[ESCUDO NACIONAL]', { align: 'center' });

    doc.moveDown(0.5);

    // Republic header
    doc
      .fontSize(12)
      .font('Helvetica-Bold')
      .text('República de Guinea Ecuatorial', { align: 'center' });

    doc.moveDown(0.3);

    // Ministry name
    doc
      .fontSize(11)
      .font('Helvetica')
      .text(
        'Ministerio de Transportes, Telecomunicaciones y Sistemas de',
        { align: 'center' },
      );

    doc.text('Inteligencia Artificial', { align: 'center' });

    doc.moveDown(0.8);

    // Separator line
    doc
      .moveTo(50, doc.y)
      .lineTo(doc.page.width - 50, doc.y)
      .stroke();

    doc.moveDown(1);
  }

  /**
   * Add document number (top-left corner)
   * Client requirement: "Formato exacto y automático de colocación del número"
   */
  private addDocumentNumber(doc: any, documentNumber: string) {
    const currentY = doc.y;

    doc
      .fontSize(11)
      .font('Helvetica-Bold')
      .text(`No. ${documentNumber}`, 50, 50);

    doc.y = currentY; // Reset position
  }

  /**
   * Add signature section for Minister
   */
  private addSignatureSection(doc: any) {
    // Signature line
    doc.fontSize(10).font('Helvetica').text('_'.repeat(40), { align: 'right' });

    doc.moveDown(0.5);

    doc.fontSize(10).text('Firma del Ministro', { align: 'right' });

    doc.moveDown(0.5);

    // Physical seal placeholder
    doc
      .fontSize(9)
      .font('Helvetica-Oblique')
      .text('(Sello físico)', { align: 'right' });

    doc.moveDown(1);
  }

  /**
   * Add footer with recipients and date
   */
  private addFooter(doc: any, recipients: string[], date: Date) {
    const bottomY = doc.page.height - 100;
    doc.y = bottomY;

    // Separator line
    doc
      .moveTo(50, doc.y)
      .lineTo(doc.page.width - 50, doc.y)
      .stroke();

    doc.moveDown(0.5);

    // Date
    doc
      .fontSize(9)
      .font('Helvetica')
      .text(`Fecha: ${date.toLocaleDateString('es-ES')}`, 50, doc.y);

    // Recipients
    if (recipients.length > 0) {
      doc.moveDown(0.5);
      doc.text('Destinatarios:', 50, doc.y);
      doc.fontSize(8).text(`- ${recipients.join('\n- ')}`, 70, doc.y + 12);
    }
  }

  /**
   * Add decree annotations to left margin
   */
  private addDecreeAnnotations(doc: any, annotations: string[]) {
    if (annotations.length === 0) return;

    const leftMargin = 20;
    let yPosition = 200;

    doc.fontSize(8).font('Helvetica-Oblique');

    for (const annotation of annotations) {
      doc.text(annotation, leftMargin, yPosition, {
        width: 60,
        align: 'left',
      });
      yPosition += 30;
    }
  }
}
